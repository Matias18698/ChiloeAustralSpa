import{C as V,r,o as F,a as L,c,b as u,d as E,u as k,m as $,w as z,e as o,f as y,n as G,t as _,g as P,F as T,h as q,v as H,i as I}from"./app-DG0kc4f6.js";import{A as K}from"./AppMain-DjWXVROa.js";import{e as v}from"./qr-scanner.min-D61zxUHk.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Q={class:"max-w-xl mx-auto p-6 bg-white shadow rounded mt-10 space-y-6"},W={key:1,class:"space-y-4"},Z=["value"],J={key:0,class:"text-sm text-center"},X=["disabled"],re={__name:"Create",props:{trabajadores:Array},setup(B){const D=B,N=new Date().toLocaleDateString("en-CA",{timeZone:"America/Santiago"}),d=V({trabajador_id:"",fecha:N,tipo_asistencia:"TR"}),m=r(null),a=r(null),f=r([]),b=r(""),x=r(null),C=r(""),g=r(!0),h=r(!1),n=r({visible:!1,mensaje:"",tipo:"success"}),j=e=>e.replace(/\./g,"").replace("-","").toLowerCase(),i=(e,t="success")=>{n.value={mensaje:e,tipo:t,visible:!0},setTimeout(()=>n.value.visible=!1,1e4)},w=({data:e})=>{console.log("QR escaneado:",e);const t=e.match(/RUN=([^\s&]*)/),s=t?t[1]:e.trim(),A=j(s),l=D.trabajadores.find(U=>j(U.rut)===A);l?(d.trabajador_id=l.id,x.value=l,C.value=l.nombre,i(`Trabajador ${l.nombre} ${l.apellido} escaneado con éxito ✅`),g.value=!1,M()):i(`❌ RUT ${A} no encontrado`,"error")},R=async()=>{try{a.value||(a.value=new v(m.value,w,{highlightScanRegion:!0,highlightCodeOutline:!0}),await p()),await a.value.start()}catch(e){console.error("Error al iniciar el escáner:",e),i("Error al acceder a la cámara","error")}},M=()=>{var e;(e=a.value)==null||e.stop()},p=async()=>{var e;try{await((e=a.value)==null?void 0:e.setCamera(b.value))}catch(t){console.error("Error al cambiar la cámara:",t)}},S=async()=>{d.trabajador_id="",x.value=null,C.value="",g.value=!0,n.value.visible=!1,a.value&&(a.value.destroy(),a.value=null),await new Promise(e=>setTimeout(e,100)),a.value=new v(m.value,w,{highlightScanRegion:!0,highlightCodeOutline:!0}),await p(),await R()},O=()=>{if(!d.trabajador_id){i("⚠️ Escanea un trabajador ","error");return}h.value=!0,d.post(route("asistencia.store"),{onSuccess:()=>{i("✅ Asistencia registrada correctamente"),S()},onError:()=>i("❌ Error al registrar asistencia","error"),onFinish:()=>h.value=!1})};return F(async()=>{var e;v.WORKER_PATH="/qr-scanner-worker.min.js",a.value=new v(m.value,w,{highlightScanRegion:!0,highlightCodeOutline:!0}),f.value=await v.listCameras(!0),b.value=(e=f.value[0])==null?void 0:e.id,await p(),await R()}),L(()=>{var e;return(e=a.value)==null?void 0:e.destroy()}),(e,t)=>(u(),c(T,null,[E(k($),{title:"Registrar Asistencia"}),E(K,null,{default:z(()=>[o("div",Q,[t[1]||(t[1]=o("h1",{class:"text-xl font-bold"},"Registrar Asistencia",-1)),n.value.visible?(u(),c("div",{key:0,class:G(["p-3 rounded",n.value.tipo==="success"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"])},_(n.value.mensaje),3)):y("",!0),g.value?(u(),c("div",W,[o("video",{ref_key:"video",ref:m,class:"w-full rounded border"},null,512),P(o("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>b.value=s),onChange:p,class:"w-full border rounded px-2 py-1"},[(u(!0),c(T,null,q(f.value,s=>(u(),c("option",{key:s.id,value:s.id},_(s.label),9,Z))),128))],544),[[H,b.value]])])):y("",!0),o("form",{onSubmit:I(O,["prevent"]),class:"space-y-4"},[g.value?y("",!0):(u(),c("div",J,[o("button",{type:"button",onClick:S,class:"text-blue-600 underline"}," Reiniciar escaneo ")])),o("button",{type:"submit",class:"w-full bg-blue-600 text-white py-2 rounded font-semibold disabled:bg-gray-300",disabled:h.value||!k(d).trabajador_id},_(h.value?"Guardando...":"Guardar Asistencia"),9,X)],32)])]),_:1})],64))}};export{re as default};
